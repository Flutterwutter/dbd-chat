<html>
    <head>
        <title>D&D Chat</title>
        <style>
            body{font-family:sans-serif; background:#111; color:white; display:flex; flex-direction:column; height:100vh; }
            #chat { flex:1; overflow-y:auto; border:1px solid #333; padding:10px; }
            #input { display:flex; gap:10px; }
            input { flex:1; padding:8px; border:none; border-radius:6px; }
            button {padding:8px 12px; border:none; border-radius:6px; background:#4a4aff; color:white; cursor:pointer; }
        </style>
    </head>
    <body>
        <h2>🧙‍♂️ D&D Group Chat</h2>

        <!-- Room selector (already added earlier) -->
        <label for="room">Choose a room:</label>
        <select id="room">
            <option value="Tavern">Tavern</option>
            <option value="Dungeon">Dungeon</option>
            <option value="Marketplace">Marketplace</option>
        </select>

        <!-- NEW: two-column layout -->
        <div style="display:grid; grid-template-columns: 240px 1fr; gap:12px; height:70vh;">
            <!-- LEFT: online users -->
            <div id="usersPanel" style="border:1px solid #333; padding:10px; overflow:auto;">
                <h3 style="margin-top:0;">Online</h3>
                <div id="users"></div>
            </div>

            <!-- RIGHT: chat area -->
            <div style="display:flex; flex-direction:column;">
                <div id="chat" style="flex:1; overflow-y:auto; border:1px solid #333; padding:10px;"></div>
                <div id="input" style="display:flex; gap:10px; margin-top:10px;">
                    <input id="msg" placeholder="Type a message..." style="flex:1;" />
                    <button>Send</button>
                </div>
            </div>
        </div>
            <script src="/socket.io/socket.io.js"></script>
        <script>
            const password = prompt("Enter chat password:");
            if (!password) {
                alert("Password required!");
            throw new Error("No password entered");
      }

            const name = prompt("Enter your name:") || "Adventurer";
            const avatar = prompt("Enter an avatar image URL (optional):") || "";
            const socket = io({auth: {password} });

            const roomSelect = document.getElementById("room");
            const chat = document.getElementById("chat");
            const msg = document.getElementById("msg");
            const btn = document.querySelector("button");
            const usersDiv = document.getElementById("users");

      socket.on("connect", () => {
                socket.emit("register", { name, avatar, text });
            socket.emit("joinRoom", roomSelect.value);
      });

      roomSelect.addEventListener("change", () => {
                socket.emit("joinRoom", roomSelect.value);
            chat.innerHTML = "";
      });

            // ✅ sendMessage actually emits to the server
            function sendMessage() {
        const text = msg.value.trim();
            if (!text) return;
            socket.emit("chat", {name, avatar, text});
            msg.value = "";
      }

            // ✅ bind both click and Enter
            btn.onclick = sendMessage;
      msg.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
                e.preventDefault();
            sendMessage();
        }
      });

      // ✅ display messages from the server
      socket.on("chat", (data) => {
        const img = data.avatar
            ? `<img src="${data.avatar}" width="20" height="20" style="border-radius:50%;vertical-align:middle;margin-right:6px;">`
                : "";
                const div = document.createElement("div");
                div.innerHTML = `${img}<strong>${data.name}</strong>: ${data.text}`;
                chat.appendChild(div);
                chat.scrollTop = chat.scrollHeight;
      });

      // system + users updates (optional)
      socket.on("system", (text) => {
        const div = document.createElement("div");
                div.innerHTML = `<em>${text}</em>`;
                chat.appendChild(div);
      });

      socket.on("users", (list) => {
                    usersDiv.innerHTML = list
                        .map(u => {
                            const img = u.avatar
                                ? `<img src="${u.avatar}" width="20" height="20" style="border-radius:50%;vertical-align:middle;margin-right:6px;">`
                                : `<span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#666;margin-right:6px;"></span>`;
                            return `<div style="margin:6px 0;">${img}${u.name}</div>`;
                        })
                        .join("");
      });

      socket.on("connect_error", (err) => {
        if (err.message === "invalid password") {
                    alert("❌ Wrong password! Access denied.");
                location.reload();
        }
      });
        </script>
    </body>
</html>